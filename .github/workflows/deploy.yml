name: Deploy to EC2

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_DIR: ${{ secrets.EC2_APP_DIR }}
          SPRING_MAIL_USERNAME: ${{ secrets.SPRING_MAIL_USERNAME }}
          SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          envs: APP_DIR,SPRING_MAIL_USERNAME,SPRING_MAIL_PASSWORD,DB_PASSWORD,MYSQL_ROOT_PASSWORD,JWT_SECRET,SENDGRID_API_KEY
          script: |
            set -euo pipefail
            cd "$APP_DIR"
            export SPRING_MAIL_USERNAME
            export SPRING_MAIL_PASSWORD
            export DB_PASSWORD
            export MYSQL_ROOT_PASSWORD
            export JWT_SECRET
            export SENDGRID_API_KEY
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
